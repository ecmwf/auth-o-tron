# Auth-O-Tron â€“ AI agent guide

- Service is an Axum web app; entrypoint loads config, init logging, then builds router and serves TCP listener [src/main.rs](src/main.rs), [src/startup.rs](src/startup.rs).
- Config is versioned; current `version: 1.0.0` struct is `ConfigV1` holding store, services, providers, augmenters, jwt, bind_address, logging, auth timeout [src/config/types.rs](src/config/types.rs). Load via Figment from `AOT_CONFIG_PATH` (default `./config.yaml`) with env overrides prefix `AOT_` using `__` for nesting (e.g., `AOT_JWT__ISS`) [src/config/types.rs](src/config/types.rs#L27-L60). Print JSON schema with `cargo run -- --schema`.
- Logging uses `logging.level` (trace|debug|info|warn|error) and `logging.format` (json|console) [src/utils/logger.rs](src/utils/logger.rs), init before server start [src/main.rs](src/main.rs#L10-L24).
- Request auth pipeline: `User` extractor reads `Authorization` (supports comma-separated multiple credentials; max 3 unique parts) and optional `X-Auth-Realm`, then `Auth::authenticate` selects providers by scheme/realm with timeouts (default 5s) and returns first success; otherwise 401 with dynamic `WWW-Authenticate` challenges [src/auth.rs](src/auth.rs), [src/models/user.rs](src/models/user.rs#L51-L128), [src/utils/http_helpers.rs](src/utils/http_helpers.rs).
- Supported auth schemes (config `providers`): ecmwf-api, ecmwf-token-generator (refresh->online exchange, jwt backend), efas-api, jwt, openid-offline (refresh->online exchange, jwt backend), plain/basic; match by `type` tag in config [src/providers/base.rs](src/providers/base.rs), provider impls in `src/providers/*`. Realm filtering is enforced when `X-Auth-Realm` is set and by provider `realm` fields.
- Augmenters run after provider success, filtered by realm; add roles/attributes without duplication. Available: ldap, plain (static role map), plain_advanced (match username or existing roles, add roles and upsert attributes) [src/augmenters/base.rs](src/augmenters/base.rs), [src/augmenters/plain_advanced_augmenter.rs](src/augmenters/plain_advanced_augmenter.rs).
- Routes: `/authenticate` GET returns JWT in `Authorization: Bearer <token>` plus optional legacy headers when `include_legacy_headers=true`; `/token` GET creates opaque token in store; `/tokens` lists; `/token/{token}` deletes; `/providers` and `/augmenters` expose sanitized config; `/health`; `/metrics` exposes Prometheus text [src/routes](src/routes), [src/routes/auth.rs](src/routes/auth.rs), [src/routes/tokens.rs](src/routes/tokens.rs).
- JWT creation uses `jwt` config (iss,aud,exp,secret). Expiry is min of config exp and user attribute `exp` when present [src/models/user.rs](src/models/user.rs#L21-L90). `User.scopes` are embedded when available.
- Token store is optional: if `store.enabled=false`, `NoStore` is used and token routes return 503-ish via `map_store_error`; otherwise backend selected by `store.backend.type` (currently MongoDB) [src/store/base.rs](src/store/base.rs), [src/config/store.rs](src/config/store.rs).
- Metrics collected for provider/augmenter attempts and auth latency; Prometheus exposition via `/metrics` [src/metrics](src/metrics), [src/routes/metrics.rs](src/routes/metrics.rs).
- Sample config lives at [config/config.yaml](config/config.yaml); env overrides prefer keeping secrets out of VCS.
- Tests: unit+integration run with `cargo test` (integration tests use mockito, no external services). Helpers build router with in-memory state [tests/common.rs](tests/common.rs). Integration examples cover plain auth and ECMWF token generator flows [tests/offline_integration.rs](tests/offline_integration.rs), [tests/ecmwf_token_generator_integration.rs](tests/ecmwf_token_generator_integration.rs).
- When adding new providers/augmenters, extend enums `ProviderConfig`/`AugmenterConfig` and factory helpers `create_auth_provider`/`create_auth_augmenter`, plus wire into metrics as needed [src/providers/base.rs](src/providers/base.rs), [src/augmenters/base.rs](src/augmenters/base.rs).
- Request handlers rely on `ConnectInfo<SocketAddr>` for client IP logging; ensure tests insert it (see helpers in [tests/common.rs](tests/common.rs)).
- Build/run locally: `cargo run` (ensure `config.yaml` present or set `AOT_CONFIG_PATH`), `cargo test` for full suite. Set `RUST_LOG` only if you need EnvFilter overrides; otherwise use config logging fields.
- Common pitfalls: forgetting realm alignment between providers and augmenters prevents augmentation; enabling store without backend exits process; JWT `aud` is optional and validation is disabled in tests; basic auth credentials must be base64 `username:password`.
